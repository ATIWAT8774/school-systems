<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Prompt', sans-serif;
      background: linear-gradient(135deg, #E8F5E9 0%, #F1F8E9 100%);
      min-height: 100%;
      overflow-x: hidden;
    }

    * {
      box-sizing: border-box;
    }

    /* Login Page Styles */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100%;
      padding: 20px;
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(46, 125, 50, 0.15);
      width: 100%;
      max-width: 420px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .logo-placeholder {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #2E7D32 0%, #66BB6A 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      color: white;
    }

    .login-title {
      text-align: center;
      color: #2E7D32;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .login-subtitle {
      text-align: center;
      color: #66BB6A;
      font-size: 16px;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #2E7D32;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #C8E6C9;
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Prompt', sans-serif;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #2E7D32;
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
    }

    .login-button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #2E7D32 0%, #388E3C 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Prompt', sans-serif;
    }

    .login-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(46, 125, 50, 0.3);
    }

    .login-button:active {
      transform: translateY(0);
    }

    /* Dashboard Styles */
    .dashboard {
      display: none;
      min-height: 100%;
    }

    .dashboard.active {
      display: block;
    }

    .top-bar {
      background: white;
      padding: 16px 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .system-info h1 {
      color: #2E7D32;
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 4px 0;
    }

    .system-info p {
      color: #66BB6A;
      font-size: 14px;
      margin: 0;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-details {
      text-align: right;
    }

    .user-name {
      color: #2E7D32;
      font-weight: 600;
      font-size: 14px;
      margin: 0;
    }

    .user-role {
      color: #81C784;
      font-size: 12px;
      margin: 0;
    }

    .logout-btn {
      background: #EF5350;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #E53935;
      transform: translateY(-1px);
    }

    .marquee-container {
      background: linear-gradient(90deg, #2E7D32 0%, #388E3C 100%);
      color: white;
      padding: 12px 0;
      overflow: hidden;
    }

    .marquee-text {
      display: inline-block;
      padding-left: 100%;
      animation: marquee 20s linear infinite;
      white-space: nowrap;
      font-size: 14px;
    }

    @keyframes marquee {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    .main-content {
      padding: 24px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .page-title {
      color: #2E7D32;
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 24px;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(46, 125, 50, 0.2);
      border-color: #A5D6A7;
    }

    .card-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #A5D6A7 0%, #81C784 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 16px;
    }

    .card-title {
      color: #2E7D32;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .card-description {
      color: #66BB6A;
      font-size: 14px;
      line-height: 1.5;
    }

    .notification-badge {
      background: #EF5350;
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 600px;
      width: 100%;
      max-height: 90%;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title {
      color: #2E7D32;
      font-size: 24px;
      font-weight: 600;
      margin: 0;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      color: #81C784;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: #E8F5E9;
      color: #2E7D32;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-family: 'Prompt', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2E7D32 0%, #388E3C 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
    }

    .btn-secondary {
      background: #E8F5E9;
      color: #2E7D32;
    }

    .btn-secondary:hover {
      background: #C8E6C9;
    }

    .btn-danger {
      background: #EF5350;
      color: white;
    }

    .btn-danger:hover {
      background: #E53935;
    }

    .teacher-list {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }

    .teacher-item {
      padding: 12px;
      background: #F1F8E9;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .teacher-item:hover {
      background: #E8F5E9;
      border-color: #A5D6A7;
    }

    .teacher-item.selected {
      background: #C8E6C9;
      border-color: #2E7D32;
    }

    .task-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(46, 125, 50, 0.1);
      margin-bottom: 16px;
      border-left: 4px solid #2E7D32;
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .task-title {
      color: #2E7D32;
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-progress {
      background: #FFF9C4;
      color: #F57F17;
    }

    .status-completed {
      background: #C8E6C9;
      color: #2E7D32;
    }

    .status-overdue {
      background: #FFCDD2;
      color: #C62828;
    }

    .task-meta {
      color: #81C784;
      font-size: 13px;
      margin-top: 8px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #81C784;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
      align-items: center;
      gap: 12px;
      z-index: 2000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); }
      to { transform: translateX(0); }
    }

    .toast.active {
      display: flex;
    }

    .toast-success {
      border-left: 4px solid #2E7D32;
    }

    .toast-error {
      border-left: 4px solid #EF5350;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #C8E6C9;
      border-radius: 8px;
      overflow: hidden;
    }

    .calendar-header {
      background: #2E7D32;
      color: white;
      padding: 12px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
    }

    .calendar-day {
      background: white;
      min-height: 80px;
      padding: 8px;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .calendar-day:hover {
      background: #F1F8E9;
    }

    .calendar-day.other-month {
      background: #F5F5F5;
      color: #999;
    }

    .calendar-day.today {
      background: #E8F5E9;
      border: 2px solid #2E7D32;
    }

    .calendar-day.has-tasks {
      background: #FFF9C4;
    }

    .day-number {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .task-dot {
      width: 6px;
      height: 6px;
      background: #2E7D32;
      border-radius: 50%;
      display: inline-block;
      margin: 1px;
    }

    .task-dot.overdue {
      background: #EF5350;
    }

    .user-card {
      background: white;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(46, 125, 50, 0.1);
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-info-card {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #A5D6A7 0%, #81C784 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
    }

    .user-details-card {
      display: flex;
      flex-direction: column;
    }

    .user-name-card {
      font-weight: 600;
      color: #2E7D32;
      margin: 0;
    }

    .user-role-card {
      font-size: 12px;
      color: #81C784;
      margin: 0;
    }

    @media (max-width: 768px) {
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      .user-info {
        width: 100%;
        justify-content: space-between;
      }

      .cards-grid {
        grid-template-columns: 1fr;
      }

      .modal-content {
        padding: 24px;
      }

      .calendar-grid {
        font-size: 12px;
      }

      .calendar-day {
        min-height: 60px;
        padding: 4px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Login Page -->
  <div id="loginPage" class="login-container">
   <div class="login-box">
    <div class="logo-placeholder">
     üè´
    </div>
    <h1 class="login-title" id="loginSystemTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h1>
    <p class="login-subtitle" id="loginSchoolName">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</p>
    <form id="loginForm">
     <div class="form-group"><label for="username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label> <input type="text" id="username" required>
     </div>
     <div class="form-group"><label for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input type="password" id="password" required>
     </div>
     <div style="background: #F1F8E9; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
      <h4 style="color: #2E7D32; margin: 0 0 12px 0; font-size: 16px;">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</h4>
      <div style="display: grid; gap: 8px; font-size: 14px; color: #666;">
       <div>
        <strong>admin/admin123</strong> - ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö
       </div>
       <div>
        <strong>director/dir123</strong> - ‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£
       </div>
       <div>
        <strong>head1/head123</strong> - ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
       </div>
       <div>
        <strong>teacher1/teach123</strong> - ‡∏Ñ‡∏£‡∏π‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
       </div>
      </div>
     </div><button type="submit" class="login-button">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </form>
   </div>
  </div><!-- Dashboard -->
  <div id="dashboard" class="dashboard">
   <div class="top-bar">
    <div class="system-info">
     <h1 id="dashboardSystemTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h1>
     <p id="dashboardSchoolName">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</p>
    </div>
    <div class="user-info">
     <div class="user-details">
      <p class="user-name" id="currentUserName">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
      <p class="user-role" id="currentUserRole">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p>
     </div><button class="logout-btn" id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
   </div>
   <div class="marquee-container">
    <div class="marquee-text" id="marqueeText">
     ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
    </div>
   </div>
   <div class="main-content">
    <h2 class="page-title">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h2>
    <div class="cards-grid" id="dashboardCards"></div>
   </div>
  </div><!-- Assign Task Modal -->
  <div id="assignTaskModal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
     <h2 class="modal-title">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2><button class="close-btn" onclick="closeModal('assignTaskModal')">√ó</button>
    </div>
    <form id="assignTaskForm">
     <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label> <input type="text" id="taskTitle" required>
     </div>
     <div class="form-group"><label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label> <textarea id="taskDescription" rows="3" required style="width: 100%; padding: 12px 16px; border: 2px solid #C8E6C9; border-radius: 8px; font-family: 'Prompt', sans-serif; resize: vertical;"></textarea>
     </div>
     <div class="form-group"><label>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label> <input type="date" id="taskDeadline" required>
     </div>
     <div class="form-group"><label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label> <select id="taskPriority" required> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</option> <option value="high">‡∏™‡∏π‡∏á</option> <option value="medium">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option> <option value="low">‡∏ï‡πà‡∏≥</option> </select>
     </div>
     <div class="form-group"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡πà‡∏≤‡∏¢</label> <select id="taskDepartment" required> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡πà‡∏≤‡∏¢</option> <option value="budget">‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</option> <option value="general">‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option> <option value="academic">‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</option> <option value="personnel">‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</option> </select>
     </div>
     <div class="form-group"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
      <div id="teacherList" class="teacher-list"></div>
     </div>
     <div class="button-group"><button type="submit" class="btn btn-primary" id="assignTaskBtn">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button> <button type="button" class="btn btn-secondary" onclick="closeModal('assignTaskModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
     </div>
    </form>
   </div>
  </div><!-- Track Tasks Modal -->
  <div id="trackTasksModal" class="modal">
   <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
     <h2 class="modal-title">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</h2><button class="close-btn" onclick="closeModal('trackTasksModal')">√ó</button>
    </div>
    <div class="filter-bar" style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;"><select id="statusFilter" style="padding: 8px 12px; border: 2px solid #C8E6C9; border-radius: 6px; font-family: 'Prompt', sans-serif;"> <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option> <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option> <option value="in_progress">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option> <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option> <option value="overdue">‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</option> </select> <select id="departmentFilter" style="padding: 8px 12px; border: 2px solid #C8E6C9; border-radius: 6px; font-family: 'Prompt', sans-serif;"> <option value="">‡∏ó‡∏∏‡∏Å‡∏ù‡πà‡∏≤‡∏¢</option> <option value="budget">‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</option> <option value="general">‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option> <option value="academic">‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</option> <option value="personnel">‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</option> </select>
    </div>
    <div id="tasksList" class="tasks-list"></div>
   </div>
  </div><!-- Task Detail Modal -->
  <div id="taskDetailModal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
     <h2 class="modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</h2><button class="close-btn" onclick="closeModal('taskDetailModal')">√ó</button>
    </div>
    <div id="taskDetailContent"></div>
    <div class="button-group" id="taskActions"></div>
   </div>
  </div><!-- Announcements Modal -->
  <div id="announcementsModal" class="modal">
   <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
     <h2 class="modal-title">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h2><button class="close-btn" onclick="closeModal('announcementsModal')">√ó</button>
    </div>
    <div style="margin-bottom: 20px;"><button class="btn btn-primary" onclick="showAddAnnouncement()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà</button>
    </div>
    <div id="addAnnouncementForm" style="display: none; background: #F1F8E9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
     <form id="announcementForm">
      <div class="form-group"><label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</label> <input type="text" id="announcementTitle" required>
      </div>
      <div class="form-group"><label>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</label> <textarea id="announcementMessage" rows="4" required style="width: 100%; padding: 12px 16px; border: 2px solid #C8E6C9; border-radius: 8px; font-family: 'Prompt', sans-serif; resize: vertical;"></textarea>
      </div>
      <div class="button-group"><button type="submit" class="btn btn-primary">‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button> <button type="button" class="btn btn-secondary" onclick="hideAddAnnouncement()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
     </form>
    </div>
    <div id="announcementsList"></div>
   </div>
  </div><!-- Problems Modal -->
  <div id="problemsModal" class="modal">
   <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
     <h2 class="modal-title">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h2><button class="close-btn" onclick="closeModal('problemsModal')">√ó</button>
    </div>
    <div style="margin-bottom: 20px;"><button class="btn btn-primary" onclick="showReportProblem()">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
    </div>
    <div id="reportProblemForm" style="display: none; background: #F1F8E9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
     <form id="problemForm">
      <div class="form-group"><label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏õ‡∏±‡∏ç‡∏´‡∏≤</label> <select id="problemCategory" required> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option> <option value="system">‡∏£‡∏∞‡∏ö‡∏ö</option> <option value="work">‡∏á‡∏≤‡∏ô</option> <option value="equipment">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</option> <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option> </select>
      </div>
      <div class="form-group"><label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</label> <textarea id="problemMessage" rows="4" required style="width: 100%; padding: 12px 16px; border: 2px solid #C8E6C9; border-radius: 8px; font-family: 'Prompt', sans-serif; resize: vertical;"></textarea>
      </div>
      <div class="button-group"><button type="submit" class="btn btn-primary">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button> <button type="button" class="btn btn-secondary" onclick="hideReportProblem()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
     </form>
    </div>
    <div id="problemsList"></div>
   </div>
  </div><!-- Calendar Modal -->
  <div id="calendarModal" class="modal">
   <div class="modal-content" style="max-width: 1000px;">
    <div class="modal-header">
     <h2 class="modal-title">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</h2><button class="close-btn" onclick="closeModal('calendarModal')">√ó</button>
    </div>
    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px; gap: 12px;">
     <div style="display: flex; gap: 12px; align-items: center;"><button class="btn btn-secondary" onclick="changeMonth(-1)">‚Äπ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</button>
      <h3 id="currentMonth" style="margin: 0; color: #2E7D32; min-width: 200px; text-align: center;"></h3><button class="btn btn-secondary" onclick="changeMonth(1)">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Ä∫</button>
     </div><button class="btn btn-primary" onclick="goToToday()">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>
    <div id="calendar" class="calendar-grid"></div>
    <div style="margin-top: 20px;">
     <h4 style="color: #2E7D32; margin-bottom: 12px;">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î</h4>
     <div id="upcomingTasks"></div>
    </div>
   </div>
  </div><!-- Reports Modal -->
  <div id="reportsModal" class="modal">
   <div class="modal-content" style="max-width: 1000px;">
    <div class="modal-header">
     <h2 class="modal-title">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</h2><button class="close-btn" onclick="closeModal('reportsModal')">√ó</button>
    </div>
    <div class="reports-dashboard">
     <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
      <div class="stat-card" style="background: #E8F5E9; padding: 20px; border-radius: 12px; text-align: center;">
       <div style="font-size: 32px; font-weight: 600; color: #2E7D32;" id="totalTasks">
        0
       </div>
       <div style="color: #66BB6A; font-size: 14px;">
        ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
       </div>
      </div>
      <div class="stat-card" style="background: #FFF9C4; padding: 20px; border-radius: 12px; text-align: center;">
       <div style="font-size: 32px; font-weight: 600; color: #F57F17;" id="pendingTasks">
        0
       </div>
       <div style="color: #FBC02D; font-size: 14px;">
        ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
       </div>
      </div>
      <div class="stat-card" style="background: #E3F2FD; padding: 20px; border-radius: 12px; text-align: center;">
       <div style="font-size: 32px; font-weight: 600; color: #1976D2;" id="inProgressTasks">
        0
       </div>
       <div style="color: #42A5F5; font-size: 14px;">
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
       </div>
      </div>
      <div class="stat-card" style="background: #C8E6C9; padding: 20px; border-radius: 12px; text-align: center;">
       <div style="font-size: 32px; font-weight: 600; color: #2E7D32;" id="completedTasks">
        0
       </div>
       <div style="color: #66BB6A; font-size: 14px;">
        ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
       </div>
      </div>
      <div class="stat-card" style="background: #FFCDD2; padding: 20px; border-radius: 12px; text-align: center;">
       <div style="font-size: 32px; font-weight: 600; color: #C62828;" id="overdueTasks">
        0
       </div>
       <div style="color: #EF5350; font-size: 14px;">
        ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î
       </div>
      </div>
     </div>
     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
       <h4 style="color: #2E7D32; margin-bottom: 16px;">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ù‡πà‡∏≤‡∏¢</h4>
       <div id="departmentStats"></div>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
       <h4 style="color: #2E7D32; margin-bottom: 16px;">‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h4>
       <div id="performanceStats"></div>
      </div>
     </div>
     <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <h4 style="color: #2E7D32; margin-bottom: 16px;">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</h4>
      <div id="overdueTasksList"></div>
     </div>
    </div>
   </div>
  </div><!-- Users Management Modal -->
  <div id="usersModal" class="modal">
   <div class="modal-content" style="max-width: 1000px;">
    <div class="modal-header">
     <h2 class="modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2><button class="close-btn" onclick="closeModal('usersModal')">√ó</button>
    </div>
    <div style="margin-bottom: 20px;"><button class="btn btn-primary" onclick="showAddUser()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</button>
    </div>
    <div id="addUserForm" style="display: none; background: #F1F8E9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
     <form id="userForm">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
       <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label> <input type="text" id="newUsername" required>
       </div>
       <div class="form-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input type="password" id="newPassword" required>
       </div>
       <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label> <input type="text" id="newFullName" required>
       </div>
       <div class="form-group"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label> <select id="newRole" required> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option> <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option> <option value="director">‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£</option> <option value="head_budget">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</option> <option value="head_general">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option> <option value="head_academic">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</option> <option value="head_personnel">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</option> <option value="teacher_budget">‡∏Ñ‡∏£‡∏π‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</option> <option value="teacher_general">‡∏Ñ‡∏£‡∏π‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option> <option value="teacher_academic">‡∏Ñ‡∏£‡∏π‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</option> <option value="teacher_personnel">‡∏Ñ‡∏£‡∏π‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</option> </select>
       </div>
      </div>
      <div class="button-group"><button type="submit" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button> <button type="button" class="btn btn-secondary" onclick="hideAddUser()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
     </form>
    </div>
    <div id="usersList"></div>
   </div>
  </div><!-- Toast Notification -->
  <div id="toast" class="toast"><span id="toastMessage"></span>
  </div>
  <script>
    const defaultConfig = {
      system_title: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
      school_name: "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤",
      announcement_text: "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤",
      primary_color: "#2E7D32",
      secondary_color: "#A5D6A7",
      background_color: "#E8F5E9",
      text_color: "#2E7D32",
      accent_color: "#66BB6A"
    };

    let currentUser = null;
    let allData = [];
    let selectedTeacher = null;
    let isLoading = false;

    // Data Handler
    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        updateNotificationCounts();
        if (document.getElementById('trackTasksModal').classList.contains('active')) {
          loadTasks();
        }
        if (document.getElementById('announcementsModal').classList.contains('active')) {
          loadAnnouncements();
        }
        if (document.getElementById('problemsModal').classList.contains('active')) {
          loadProblems();
        }
      }
    };

    function getAllUsers() {
      return allData.filter(item => item.type === 'user');
    }

    function getAllTasks() {
      return allData.filter(item => item.type === 'task');
    }

    function getAllAnnouncements() {
      return allData.filter(item => item.type === 'announcement');
    }

    function getAllProblems() {
      return allData.filter(item => item.type === 'problem');
    }

    // Initialize SDK
    async function initializeApp() {
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        console.error("Failed to initialize data SDK");
        return;
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            const systemTitle = config.system_title || defaultConfig.system_title;
            const schoolName = config.school_name || defaultConfig.school_name;
            const announcementText = config.announcement_text || defaultConfig.announcement_text;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
            const backgroundColor = config.background_color || defaultConfig.background_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const accentColor = config.accent_color || defaultConfig.accent_color;

            document.getElementById('loginSystemTitle').textContent = systemTitle;
            document.getElementById('loginSchoolName').textContent = schoolName;
            document.getElementById('dashboardSystemTitle').textContent = systemTitle;
            document.getElementById('dashboardSchoolName').textContent = schoolName;
            document.getElementById('marqueeText').textContent = announcementText;

            document.body.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, #F1F8E9 100%)`;
            
            const styleElements = document.querySelectorAll('.login-title, .page-title, .modal-title, .card-title, .task-title, .user-name');
            styleElements.forEach(el => el.style.color = textColor);

            const accentElements = document.querySelectorAll('.login-subtitle, .system-info p, .user-role, .card-description');
            accentElements.forEach(el => el.style.color = accentColor);
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ primary_color: value });
                  }
                }
              },
              {
                get: () => config.secondary_color || defaultConfig.secondary_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ secondary_color: value });
                  }
                }
              },
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ background_color: value });
                  }
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ text_color: value });
                  }
                }
              },
              {
                get: () => config.accent_color || defaultConfig.accent_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ accent_color: value });
                  }
                }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ["system_title", config.system_title || defaultConfig.system_title],
            ["school_name", config.school_name || defaultConfig.school_name],
            ["announcement_text", config.announcement_text || defaultConfig.announcement_text]
          ])
        });
      }
    }

    // Predefined test accounts
    const testAccounts = [
      { username: 'admin', password: 'admin123', fullName: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', role: 'admin', department: 'all' },
      { username: 'director', password: 'dir123', fullName: '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£', role: 'director', department: 'all' },
      { username: 'head1', password: 'head123', fullName: '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì', role: 'head_budget', department: 'budget' },
      { username: 'teacher1', password: 'teach123', fullName: '‡∏Ñ‡∏£‡∏π‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì', role: 'teacher_budget', department: 'budget' }
    ];

    // Login Form Handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (isLoading) return;
      isLoading = true;
      
      const loginBtn = e.target.querySelector('button[type="submit"]');
      const originalText = loginBtn.textContent;
      loginBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
      loginBtn.disabled = true;
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      // Check test accounts first
      const testAccount = testAccounts.find(acc => acc.username === username && acc.password === password);
      
      if (testAccount) {
        const allUsers = getAllUsers();
        let existingUser = allUsers.find(u => u.username === username);
        
        if (!existingUser) {
          // Create test account in database
          const newUser = {
            id: Date.now().toString(),
            type: 'user',
            username: testAccount.username,
            password: testAccount.password,
            fullName: testAccount.fullName,
            role: testAccount.role,
            department: testAccount.department,
            createdAt: new Date().toISOString()
          };

          const createResult = await window.dataSdk.create(newUser);
          
          if (createResult.isOk) {
            currentUser = newUser;
            showDashboard();
          } else {
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', 'error');
          }
        } else {
          currentUser = existingUser;
          showDashboard();
        }
      } else {
        // Check existing users
        const allUsers = getAllUsers();
        const existingUser = allUsers.find(u => u.username === username && u.password === password);
        
        if (existingUser) {
          currentUser = existingUser;
          showDashboard();
        } else {
          showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        }
      }
      
      isLoading = false;
      loginBtn.textContent = originalText;
      loginBtn.disabled = false;
    });

    function getDepartmentFromRole(role) {
      if (role.includes('budget')) return 'budget';
      if (role.includes('general')) return 'general';
      if (role.includes('academic')) return 'academic';
      if (role.includes('personnel')) return 'personnel';
      return 'all';
    }

    function showDashboard() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('dashboard').classList.add('active');
      
      document.getElementById('currentUserName').textContent = currentUser.fullName;
      document.getElementById('currentUserRole').textContent = getRoleDisplayName(currentUser.role);
      
      renderDashboardCards();
    }

    function getRoleDisplayName(role) {
      const roleNames = {
        'admin': '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
        'director': '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£',
        'head_budget': '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì',
        'head_general': '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
        'head_academic': '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£',
        'head_personnel': '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£',
        'teacher_budget': '‡∏Ñ‡∏£‡∏π‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì',
        'teacher_general': '‡∏Ñ‡∏£‡∏π‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
        'teacher_academic': '‡∏Ñ‡∏£‡∏π‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£',
        'teacher_personnel': '‡∏Ñ‡∏£‡∏π‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£'
      };
      return roleNames[role] || role;
    }

    function updateNotificationCounts() {
      if (!currentUser) return;
      
      const tasks = getAllTasks();
      const myTasks = tasks.filter(t => t.assignedTo === currentUser.id);
      const pendingTasks = myTasks.filter(t => t.status === 'pending').length;
      const overdueTasks = myTasks.filter(t => {
        const deadline = new Date(t.deadline);
        const now = new Date();
        return deadline < now && t.status !== 'completed';
      }).length;
      
      // Update notification counts in cards
      setTimeout(() => {
        const trackCard = document.querySelector('[onclick="handleCardClick(\'track\')"]');
        if (trackCard && (pendingTasks > 0 || overdueTasks > 0)) {
          const existingBadge = trackCard.querySelector('.notification-badge');
          if (existingBadge) existingBadge.remove();
          
          const badge = document.createElement('span');
          badge.className = 'notification-badge';
          badge.textContent = pendingTasks + overdueTasks;
          trackCard.querySelector('.card-title').appendChild(badge);
        }
      }, 100);
    }

    function renderDashboardCards() {
      const cardsContainer = document.getElementById('dashboardCards');
      const cards = getCardsForRole(currentUser.role);
      
      cardsContainer.innerHTML = cards.map(card => `
        <div class="card" onclick="handleCardClick('${card.action}')">
          <div class="card-icon">${card.icon}</div>
          <h3 class="card-title">${card.title}</h3>
          <p class="card-description">${card.description}</p>
        </div>
      `).join('');
      
      updateNotificationCounts();
    }

    function getCardsForRole(role) {
      const allCards = [
        { icon: 'üìã', title: '‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', description: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà', action: 'assign' },
        { icon: 'üìä', title: '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô', description: '‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô', action: 'track' },
        { icon: 'üìÖ', title: '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô', description: '‡∏î‡∏π‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏î‡πÑ‡∏•‡∏ô‡πå', action: 'calendar' },
        { icon: 'üì¢', title: '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®', description: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏∞‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£', action: 'announcements' },
        { icon: 'üìà', title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', description: '‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', action: 'reports' },
        { icon: '‚ö†Ô∏è', title: '‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤', description: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞', action: 'problems' },
        { icon: 'üë•', title: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', description: '‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', action: 'users' }
      ];

      if (role === 'admin') {
        return allCards;
      } else if (role === 'director') {
        return allCards.filter(c => c.action !== 'users');
      } else if (role.startsWith('head_')) {
        return allCards.filter(c => !['users'].includes(c.action));
      } else {
        return allCards.filter(c => ['track', 'calendar', 'problems'].includes(c.action));
      }
    }

    function handleCardClick(action) {
      switch(action) {
        case 'assign':
          openModal('assignTaskModal');
          loadTeacherList();
          break;
        case 'track':
          openModal('trackTasksModal');
          loadTasks();
          break;
        case 'announcements':
          openModal('announcementsModal');
          loadAnnouncements();
          break;
        case 'problems':
          openModal('problemsModal');
          loadProblems();
          break;
        case 'calendar':
          openModal('calendarModal');
          loadCalendar();
          break;
        case 'reports':
          openModal('reportsModal');
          loadReports();
          break;
        case 'users':
          openModal('usersModal');
          loadUsers();
          break;
        default:
          showToast(`‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ ${action}`, 'success');
      }
    }

    function loadTeacherList() {
      const department = document.getElementById('taskDepartment').value;
      if (!department) {
        document.getElementById('teacherList').innerHTML = '<p style="color: #81C784; text-align: center;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô</p>';
        return;
      }

      const allUsers = getAllUsers();
      let teachers = [];
      
      if (currentUser.role === 'director') {
        // Director can assign to department heads and teachers
        teachers = allUsers.filter(u => 
          (u.role.startsWith('head_') || u.role.startsWith('teacher_')) && 
          u.department === department
        );
      } else if (currentUser.role.startsWith('head_')) {
        // Department heads can assign to teachers in their department
        teachers = allUsers.filter(u => 
          u.role.startsWith('teacher_') && u.department === department
        );
      }

      if (teachers.length === 0) {
        document.getElementById('teacherList').innerHTML = '<p style="color: #81C784; text-align: center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏ô‡∏µ‡πâ</p>';
        return;
      }

      document.getElementById('teacherList').innerHTML = teachers.map(teacher => `
        <div class="teacher-item" onclick="selectTeacher('${teacher.id}')">
          <span>üë§</span>
          <span>${teacher.fullName} (${getRoleDisplayName(teacher.role)})</span>
        </div>
      `).join('');
    }

    function selectTeacher(teacherId) {
      selectedTeacher = teacherId;
      document.querySelectorAll('.teacher-item').forEach(item => {
        item.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
    }

    document.getElementById('taskDepartment').addEventListener('change', loadTeacherList);

    document.getElementById('assignTaskForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (isLoading) return;
      
      if (!selectedTeacher) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö', 'error');
        return;
      }

      if (getAllTasks().length >= 999) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'error');
        return;
      }

      isLoading = true;
      const submitBtn = document.getElementById('assignTaskBtn');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...';
      submitBtn.disabled = true;

      const newTask = {
        id: Date.now().toString(),
        type: 'task',
        title: document.getElementById('taskTitle').value,
        description: document.getElementById('taskDescription').value,
        deadline: document.getElementById('taskDeadline').value,
        priority: document.getElementById('taskPriority').value,
        assignedTo: selectedTeacher,
        assignedBy: currentUser.id,
        status: 'pending',
        createdAt: new Date().toISOString()
      };

      const createResult = await window.dataSdk.create(newTask);
      
      if (createResult.isOk) {
        closeModal('assignTaskModal');
        showToast('‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        document.getElementById('assignTaskForm').reset();
        selectedTeacher = null;
        document.querySelectorAll('.teacher-item').forEach(item => {
          item.classList.remove('selected');
        });
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'error');
      }
      
      isLoading = false;
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    });

    // Task Management Functions
    function loadTasks() {
      const tasks = getAllTasks();
      const allUsers = getAllUsers();
      
      let filteredTasks = tasks;
      
      // Filter by role permissions
      if (currentUser.role.startsWith('teacher_')) {
        filteredTasks = tasks.filter(t => t.assignedTo === currentUser.id);
      } else if (currentUser.role.startsWith('head_')) {
        const departmentUsers = allUsers.filter(u => u.department === currentUser.department);
        const departmentUserIds = departmentUsers.map(u => u.id);
        filteredTasks = tasks.filter(t => 
          departmentUserIds.includes(t.assignedTo) || t.assignedBy === currentUser.id
        );
      }
      
      // Apply filters
      const statusFilter = document.getElementById('statusFilter').value;
      const departmentFilter = document.getElementById('departmentFilter').value;
      
      if (statusFilter) {
        filteredTasks = filteredTasks.filter(t => {
          if (statusFilter === 'overdue') {
            const deadline = new Date(t.deadline);
            const now = new Date();
            return deadline < now && t.status !== 'completed';
          }
          return t.status === statusFilter;
        });
      }
      
      if (departmentFilter) {
        const departmentUsers = allUsers.filter(u => u.department === departmentFilter);
        const departmentUserIds = departmentUsers.map(u => u.id);
        filteredTasks = filteredTasks.filter(t => departmentUserIds.includes(t.assignedTo));
      }
      
      renderTasks(filteredTasks, allUsers);
    }

    function renderTasks(tasks, users) {
      const tasksList = document.getElementById('tasksList');
      
      if (tasks.length === 0) {
        tasksList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>
          </div>
        `;
        return;
      }
      
      tasksList.innerHTML = tasks.map(task => {
        const assignedUser = users.find(u => u.id === task.assignedTo);
        const assignedByUser = users.find(u => u.id === task.assignedBy);
        const deadline = new Date(task.deadline);
        const now = new Date();
        const isOverdue = deadline < now && task.status !== 'completed';
        
        let statusClass = 'status-progress';
        let statusText = '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
        
        if (task.status === 'completed') {
          statusClass = 'status-completed';
          statusText = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
        } else if (task.status === 'in_progress') {
          statusClass = 'status-progress';
          statusText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
        } else if (isOverdue) {
          statusClass = 'status-overdue';
          statusText = '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î';
        }
        
        return `
          <div class="task-card" onclick="showTaskDetail('${task.id}')">
            <div class="task-header">
              <h4 class="task-title">${task.title}</h4>
              <span class="status-badge ${statusClass}">${statusText}</span>
            </div>
            <p style="color: #666; margin: 8px 0;">${task.description}</p>
            <div class="task-meta">
              <div>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö: ${assignedUser ? assignedUser.fullName : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
              <div>‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÇ‡∏î‡∏¢: ${assignedByUser ? assignedByUser.fullName : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
              <div>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: ${new Date(task.deadline).toLocaleDateString('th-TH')}</div>
              <div>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ${getPriorityText(task.priority)}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function getPriorityText(priority) {
      const priorities = {
        'high': '‡∏™‡∏π‡∏á',
        'medium': '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
        'low': '‡∏ï‡πà‡∏≥'
      };
      return priorities[priority] || priority;
    }

    function showTaskDetail(taskId) {
      const tasks = getAllTasks();
      const allUsers = getAllUsers();
      const task = tasks.find(t => t.id === taskId);
      
      if (!task) return;
      
      const assignedUser = allUsers.find(u => u.id === task.assignedTo);
      const assignedByUser = allUsers.find(u => u.id === task.assignedBy);
      
      const deadline = new Date(task.deadline);
      const now = new Date();
      const isOverdue = deadline < now && task.status !== 'completed';
      
      let statusText = '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
      if (task.status === 'completed') statusText = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
      else if (task.status === 'in_progress') statusText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
      else if (isOverdue) statusText = '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î';
      
      document.getElementById('taskDetailContent').innerHTML = `
        <div style="margin-bottom: 20px;">
          <h3 style="color: #2E7D32; margin-bottom: 16px;">${task.title}</h3>
          <div style="background: #F1F8E9; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <p style="margin: 0; line-height: 1.6;">${task.description}</p>
          </div>
          <div style="display: grid; gap: 12px;">
            <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${statusText}</div>
            <div><strong>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</strong> ${assignedUser ? assignedUser.fullName : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
            <div><strong>‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÇ‡∏î‡∏¢:</strong> ${assignedByUser ? assignedByUser.fullName : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
            <div><strong>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á:</strong> ${new Date(task.deadline).toLocaleDateString('th-TH')}</div>
            <div><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong> ${getPriorityText(task.priority)}</div>
            <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á:</strong> ${new Date(task.createdAt).toLocaleDateString('th-TH')}</div>
            ${task.completedAt ? `<div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô:</strong> ${new Date(task.completedAt).toLocaleDateString('th-TH')}</div>` : ''}
          </div>
        </div>
      `;
      
      // Show action buttons based on permissions
      let actions = '';
      
      if (task.assignedTo === currentUser.id && task.status !== 'completed') {
        if (task.status === 'pending') {
          actions += `<button class="btn btn-primary" onclick="updateTaskStatus('${task.id}', 'in_progress')">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</button>`;
        }
        if (task.status === 'in_progress') {
          actions += `<button class="btn btn-primary" onclick="updateTaskStatus('${task.id}', 'completed')">‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>`;
        }
      }
      
      if (task.assignedBy === currentUser.id || currentUser.role === 'director' || currentUser.role === 'admin') {
        actions += `<button class="btn btn-danger" onclick="deleteTask('${task.id}')">‡∏•‡∏ö‡∏á‡∏≤‡∏ô</button>`;
      }
      
      document.getElementById('taskActions').innerHTML = actions;
      openModal('taskDetailModal');
    }

    async function updateTaskStatus(taskId, newStatus) {
      if (isLoading) return;
      
      isLoading = true;
      const tasks = getAllTasks();
      const task = tasks.find(t => t.id === taskId);
      
      if (!task) {
        isLoading = false;
        return;
      }
      
      const updatedTask = { ...task, status: newStatus };
      if (newStatus === 'completed') {
        updatedTask.completedAt = new Date().toISOString();
      }
      
      const updateResult = await window.dataSdk.update(updatedTask);
      
      if (updateResult.isOk) {
        showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        closeModal('taskDetailModal');
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 'error');
      }
      
      isLoading = false;
    }

    async function deleteTask(taskId) {
      if (isLoading) return;
      
      // Show inline confirmation
      const confirmBtn = event.target;
      const originalText = confirmBtn.textContent;
      confirmBtn.textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
      confirmBtn.style.background = '#D32F2F';
      
      setTimeout(() => {
        confirmBtn.textContent = originalText;
        confirmBtn.style.background = '';
      }, 3000);
      
      if (confirmBtn.dataset.confirmed === 'true') {
        isLoading = true;
        const tasks = getAllTasks();
        const task = tasks.find(t => t.id === taskId);
        
        if (task) {
          const deleteResult = await window.dataSdk.delete(task);
          
          if (deleteResult.isOk) {
            showToast('‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            closeModal('taskDetailModal');
          } else {
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô', 'error');
          }
        }
        
        isLoading = false;
        confirmBtn.dataset.confirmed = 'false';
      } else {
        confirmBtn.dataset.confirmed = 'true';
      }
    }

    // Event listeners for task filters
    document.getElementById('statusFilter').addEventListener('change', loadTasks);
    document.getElementById('departmentFilter').addEventListener('change', loadTasks);

    document.getElementById('logoutBtn').addEventListener('click', () => {
      currentUser = null;
      document.getElementById('dashboard').classList.remove('active');
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('loginForm').reset();
    });

    // Announcements Management
    function loadAnnouncements() {
      const announcements = getAllAnnouncements();
      const allUsers = getAllUsers();
      
      renderAnnouncements(announcements, allUsers);
    }

    function renderAnnouncements(announcements, users) {
      const announcementsList = document.getElementById('announcementsList');
      
      if (announcements.length === 0) {
        announcementsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì¢</div>
            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</p>
          </div>
        `;
        return;
      }
      
      announcementsList.innerHTML = announcements.map(announcement => {
        const author = users.find(u => u.id === announcement.assignedBy);
        return `
          <div class="task-card">
            <div class="task-header">
              <h4 class="task-title">${announcement.title}</h4>
              ${canDeleteAnnouncement(announcement) ? `<button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteAnnouncement('${announcement.id}')">‡∏•‡∏ö</button>` : ''}
            </div>
            <p style="color: #666; margin: 8px 0; line-height: 1.6;">${announcement.message}</p>
            <div class="task-meta">
              <div>‡πÇ‡∏î‡∏¢: ${author ? author.fullName : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
              <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(announcement.createdAt).toLocaleDateString('th-TH')}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function canDeleteAnnouncement(announcement) {
      return announcement.assignedBy === currentUser.id || 
             currentUser.role === 'director' || 
             currentUser.role === 'admin';
    }

    function showAddAnnouncement() {
      document.getElementById('addAnnouncementForm').style.display = 'block';
    }

    function hideAddAnnouncement() {
      document.getElementById('addAnnouncementForm').style.display = 'none';
      document.getElementById('announcementForm').reset();
    }

    document.getElementById('announcementForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (isLoading) return;
      
      if (getAllAnnouncements().length >= 999) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'error');
        return;
      }

      isLoading = true;
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà...';
      submitBtn.disabled = true;

      const newAnnouncement = {
        id: Date.now().toString(),
        type: 'announcement',
        title: document.getElementById('announcementTitle').value,
        message: document.getElementById('announcementMessage').value,
        assignedBy: currentUser.id,
        createdAt: new Date().toISOString()
      };

      const createResult = await window.dataSdk.create(newAnnouncement);
      
      if (createResult.isOk) {
        showToast('‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        hideAddAnnouncement();
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®', 'error');
      }
      
      isLoading = false;
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    });

    async function deleteAnnouncement(announcementId) {
      if (isLoading) return;
      
      const confirmBtn = event.target;
      const originalText = confirmBtn.textContent;
      confirmBtn.textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
      confirmBtn.style.background = '#D32F2F';
      
      setTimeout(() => {
        confirmBtn.textContent = originalText;
        confirmBtn.style.background = '';
      }, 3000);
      
      if (confirmBtn.dataset.confirmed === 'true') {
        isLoading = true;
        const announcements = getAllAnnouncements();
        const announcement = announcements.find(a => a.id === announcementId);
        
        if (announcement) {
          const deleteResult = await window.dataSdk.delete(announcement);
          
          if (deleteResult.isOk) {
            showToast('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          } else {
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®', 'error');
          }
        }
        
        isLoading = false;
        confirmBtn.dataset.confirmed = 'false';
      } else {
        confirmBtn.dataset.confirmed = 'true';
      }
    }

    // Problems Management
    function loadProblems() {
      const problems = getAllProblems();
      const allUsers = getAllUsers();
      
      let filteredProblems = problems;
      
      // Filter by role permissions
      if (!['admin', 'director'].includes(currentUser.role)) {
        filteredProblems = problems.filter(p => p.assignedBy === currentUser.id);
      }
      
      renderProblems(filteredProblems, allUsers);
    }

    function renderProblems(problems, users) {
      const problemsList = document.getElementById('problemsList');
      
      if (problems.length === 0) {
        problemsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤</p>
          </div>
        `;
        return;
      }
      
      problemsList.innerHTML = problems.map(problem => {
        const reporter = users.find(u => u.id === problem.assignedBy);
        return `
          <div class="task-card">
            <div class="task-header">
              <h4 class="task-title">‡∏õ‡∏±‡∏ç‡∏´‡∏≤${getCategoryText(problem.category)}</h4>
              ${canDeleteProblem(problem) ? `<button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteProblem('${problem.id}')">‡∏•‡∏ö</button>` : ''}
            </div>
            <p style="color: #666; margin: 8px 0; line-height: 1.6;">${problem.message}</p>
            <div class="task-meta">
              <div>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢: ${reporter ? reporter.fullName : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
              <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(problem.createdAt).toLocaleDateString('th-TH')}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function getCategoryText(category) {
      const categories = {
        'system': '‡∏£‡∏∞‡∏ö‡∏ö',
        'work': '‡∏á‡∏≤‡∏ô',
        'equipment': '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå',
        'other': '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
      };
      return categories[category] || category;
    }

    function canDeleteProblem(problem) {
      return problem.assignedBy === currentUser.id || 
             currentUser.role === 'director' || 
             currentUser.role === 'admin';
    }

    function showReportProblem() {
      document.getElementById('reportProblemForm').style.display = 'block';
    }

    function hideReportProblem() {
      document.getElementById('reportProblemForm').style.display = 'none';
      document.getElementById('problemForm').reset();
    }

    document.getElementById('problemForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (isLoading) return;
      
      if (getAllProblems().length >= 999) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'error');
        return;
      }

      isLoading = true;
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...';
      submitBtn.disabled = true;

      const newProblem = {
        id: Date.now().toString(),
        type: 'problem',
        category: document.getElementById('problemCategory').value,
        message: document.getElementById('problemMessage').value,
        assignedBy: currentUser.id,
        createdAt: new Date().toISOString()
      };

      const createResult = await window.dataSdk.create(newProblem);
      
      if (createResult.isOk) {
        showToast('‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        hideReportProblem();
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'error');
      }
      
      isLoading = false;
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    });

    async function deleteProblem(problemId) {
      if (isLoading) return;
      
      const confirmBtn = event.target;
      const originalText = confirmBtn.textContent;
      confirmBtn.textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
      confirmBtn.style.background = '#D32F2F';
      
      setTimeout(() => {
        confirmBtn.textContent = originalText;
        confirmBtn.style.background = '';
      }, 3000);
      
      if (confirmBtn.dataset.confirmed === 'true') {
        isLoading = true;
        const problems = getAllProblems();
        const problem = problems.find(p => p.id === problemId);
        
        if (problem) {
          const deleteResult = await window.dataSdk.delete(problem);
          
          if (deleteResult.isOk) {
            showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          } else {
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'error');
          }
        }
        
        isLoading = false;
        confirmBtn.dataset.confirmed = 'false';
      } else {
        confirmBtn.dataset.confirmed = 'true';
      }
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      
      toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'} active`;
      toastMessage.textContent = message;
      
      setTimeout(() => {
        toast.classList.remove('active');
      }, 3000);
    }

    // Calendar functionality
    let currentCalendarDate = new Date();

    function loadCalendar() {
      renderCalendar();
      loadUpcomingTasks();
    }

    function renderCalendar() {
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      
      // Update month display
      const monthNames = [
        '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
        '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
      ];
      document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year + 543}`;
      
      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      
      // Get tasks for this month
      const tasks = getAllTasks();
      const monthTasks = tasks.filter(task => {
        const taskDate = new Date(task.deadline);
        return taskDate.getFullYear() === year && taskDate.getMonth() === month;
      });
      
      // Create calendar grid
      let calendarHTML = '';
      
      // Headers
      const dayHeaders = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'];
      dayHeaders.forEach(day => {
        calendarHTML += `<div class="calendar-header">${day}</div>`;
      });
      
      // Previous month days
      const prevMonth = new Date(year, month - 1, 0);
      const prevMonthDays = prevMonth.getDate();
      for (let i = startingDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthDays - i;
        calendarHTML += `<div class="calendar-day other-month">
          <div class="day-number">${day}</div>
        </div>`;
      }
      
      // Current month days
      const today = new Date();
      for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = new Date(year, month, day);
        const isToday = currentDate.toDateString() === today.toDateString();
        
        // Get tasks for this day
        const dayTasks = monthTasks.filter(task => {
          const taskDate = new Date(task.deadline);
          return taskDate.getDate() === day;
        });
        
        let dayClass = 'calendar-day';
        if (isToday) dayClass += ' today';
        if (dayTasks.length > 0) dayClass += ' has-tasks';
        
        let taskDots = '';
        dayTasks.forEach(task => {
          const isOverdue = new Date(task.deadline) < today && task.status !== 'completed';
          taskDots += `<span class="task-dot${isOverdue ? ' overdue' : ''}"></span>`;
        });
        
        calendarHTML += `<div class="${dayClass}">
          <div class="day-number">${day}</div>
          <div>${taskDots}</div>
        </div>`;
      }
      
      // Next month days
      const totalCells = Math.ceil((startingDayOfWeek + daysInMonth) / 7) * 7;
      const remainingCells = totalCells - (startingDayOfWeek + daysInMonth);
      for (let day = 1; day <= remainingCells; day++) {
        calendarHTML += `<div class="calendar-day other-month">
          <div class="day-number">${day}</div>
        </div>`;
      }
      
      document.getElementById('calendar').innerHTML = calendarHTML;
    }

    function loadUpcomingTasks() {
      const tasks = getAllTasks();
      const allUsers = getAllUsers();
      const today = new Date();
      const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
      
      let upcomingTasks = tasks.filter(task => {
        const taskDate = new Date(task.deadline);
        return taskDate >= today && taskDate <= nextWeek && task.status !== 'completed';
      });
      
      // Filter by permissions
      if (currentUser.role.startsWith('teacher_')) {
        upcomingTasks = upcomingTasks.filter(t => t.assignedTo === currentUser.id);
      } else if (currentUser.role.startsWith('head_')) {
        const departmentUsers = allUsers.filter(u => u.department === currentUser.department);
        const departmentUserIds = departmentUsers.map(u => u.id);
        upcomingTasks = upcomingTasks.filter(t => 
          departmentUserIds.includes(t.assignedTo) || t.assignedBy === currentUser.id
        );
      }
      
      upcomingTasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
      
      if (upcomingTasks.length === 0) {
        document.getElementById('upcomingTasks').innerHTML = '<p style="color: #81C784; text-align: center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</p>';
        return;
      }
      
      document.getElementById('upcomingTasks').innerHTML = upcomingTasks.map(task => {
        const assignedUser = allUsers.find(u => u.id === task.assignedTo);
        const daysLeft = Math.ceil((new Date(task.deadline) - today) / (1000 * 60 * 60 * 24));
        
        return `
          <div class="task-card" style="margin-bottom: 8px; padding: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong style="color: #2E7D32;">${task.title}</strong>
                <div style="font-size: 12px; color: #666;">
                  ${assignedUser ? assignedUser.fullName : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} ‚Ä¢ 
                  ${daysLeft === 0 ? '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' : daysLeft === 1 ? '‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ' : `‡∏≠‡∏µ‡∏Å ${daysLeft} ‡∏ß‡∏±‡∏ô`}
                </div>
              </div>
              <span class="status-badge ${task.priority === 'high' ? 'status-overdue' : 'status-progress'}" style="font-size: 10px;">
                ${getPriorityText(task.priority)}
              </span>
            </div>
          </div>
        `;
      }).join('');
    }

    function changeMonth(direction) {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
      renderCalendar();
      loadUpcomingTasks();
    }

    function goToToday() {
      currentCalendarDate = new Date();
      renderCalendar();
      loadUpcomingTasks();
    }

    // Reports functionality
    function loadReports() {
      const tasks = getAllTasks();
      const allUsers = getAllUsers();
      const today = new Date();
      
      // Filter tasks by permissions
      let visibleTasks = tasks;
      if (currentUser.role.startsWith('teacher_')) {
        visibleTasks = tasks.filter(t => t.assignedTo === currentUser.id);
      } else if (currentUser.role.startsWith('head_')) {
        const departmentUsers = allUsers.filter(u => u.department === currentUser.department);
        const departmentUserIds = departmentUsers.map(u => u.id);
        visibleTasks = tasks.filter(t => 
          departmentUserIds.includes(t.assignedTo) || t.assignedBy === currentUser.id
        );
      }
      
      // Calculate statistics
      const totalTasks = visibleTasks.length;
      const pendingTasks = visibleTasks.filter(t => t.status === 'pending').length;
      const inProgressTasks = visibleTasks.filter(t => t.status === 'in_progress').length;
      const completedTasks = visibleTasks.filter(t => t.status === 'completed').length;
      const overdueTasks = visibleTasks.filter(t => {
        const deadline = new Date(t.deadline);
        return deadline < today && t.status !== 'completed';
      }).length;
      
      // Update statistics
      document.getElementById('totalTasks').textContent = totalTasks;
      document.getElementById('pendingTasks').textContent = pendingTasks;
      document.getElementById('inProgressTasks').textContent = inProgressTasks;
      document.getElementById('completedTasks').textContent = completedTasks;
      document.getElementById('overdueTasks').textContent = overdueTasks;
      
      // Department statistics
      const departments = ['budget', 'general', 'academic', 'personnel'];
      const departmentNames = {
        'budget': '‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì',
        'general': '‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
        'academic': '‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£',
        'personnel': '‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£'
      };
      
      let departmentStatsHTML = '';
      departments.forEach(dept => {
        const deptUsers = allUsers.filter(u => u.department === dept);
        const deptUserIds = deptUsers.map(u => u.id);
        const deptTasks = visibleTasks.filter(t => deptUserIds.includes(t.assignedTo));
        const deptCompleted = deptTasks.filter(t => t.status === 'completed').length;
        const completionRate = deptTasks.length > 0 ? Math.round((deptCompleted / deptTasks.length) * 100) : 0;
        
        departmentStatsHTML += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #E8F5E9;">
            <span>${departmentNames[dept]}</span>
            <div style="text-align: right;">
              <div style="font-weight: 600; color: #2E7D32;">${completionRate}%</div>
              <div style="font-size: 12px; color: #666;">${deptCompleted}/${deptTasks.length}</div>
            </div>
          </div>
        `;
      });
      document.getElementById('departmentStats').innerHTML = departmentStatsHTML;
      
      // Performance statistics
      const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      const thisMonthTasks = visibleTasks.filter(t => new Date(t.createdAt) >= thisMonth);
      const thisMonthCompleted = thisMonthTasks.filter(t => t.status === 'completed').length;
      const monthlyCompletionRate = thisMonthTasks.length > 0 ? Math.round((thisMonthCompleted / thisMonthTasks.length) * 100) : 0;
      
      const avgCompletionTime = calculateAverageCompletionTime(visibleTasks.filter(t => t.status === 'completed'));
      
      document.getElementById('performanceStats').innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #E8F5E9;">
          <span>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
          <span style="font-weight: 600; color: #2E7D32;">${monthlyCompletionRate}%</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #E8F5E9;">
          <span>‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
          <span style="font-weight: 600; color: #2E7D32;">${thisMonthTasks.length}</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
          <span>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>
          <span style="font-weight: 600; color: #2E7D32;">${avgCompletionTime} ‡∏ß‡∏±‡∏ô</span>
        </div>
      `;
      
      // Overdue tasks list
      const overdueTasks = visibleTasks.filter(t => {
        const deadline = new Date(t.deadline);
        return deadline < today && t.status !== 'completed';
      });
      
      if (overdueTasks.length === 0) {
        document.getElementById('overdueTasksList').innerHTML = '<p style="color: #81C784; text-align: center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p>';
      } else {
        document.getElementById('overdueTasksList').innerHTML = overdueTasks.map(task => {
          const assignedUser = allUsers.find(u => u.id === task.assignedTo);
          const daysOverdue = Math.ceil((today - new Date(task.deadline)) / (1000 * 60 * 60 * 24));
          
          return `
            <div class="task-card" style="margin-bottom: 8px; padding: 12px; border-left-color: #EF5350;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong style="color: #C62828;">${task.title}</strong>
                  <div style="font-size: 12px; color: #666;">
                    ${assignedUser ? assignedUser.fullName : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} ‚Ä¢ ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${daysOverdue} ‡∏ß‡∏±‡∏ô
                  </div>
                </div>
                <span class="status-badge status-overdue" style="font-size: 10px;">
                  ${getPriorityText(task.priority)}
                </span>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    function calculateAverageCompletionTime(completedTasks) {
      if (completedTasks.length === 0) return 0;
      
      const totalDays = completedTasks.reduce((sum, task) => {
        const created = new Date(task.createdAt);
        const completed = new Date(task.completedAt);
        const days = Math.ceil((completed - created) / (1000 * 60 * 60 * 24));
        return sum + days;
      }, 0);
      
      return Math.round(totalDays / completedTasks.length);
    }

    // Users management functionality
    function loadUsers() {
      const allUsers = getAllUsers();
      renderUsers(allUsers);
    }

    function renderUsers(users) {
      const usersList = document.getElementById('usersList');
      
      if (users.length === 0) {
        usersList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üë•</div>
            <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
          </div>
        `;
        return;
      }
      
      usersList.innerHTML = users.map(user => `
        <div class="user-card">
          <div class="user-info-card">
            <div class="user-avatar">${user.fullName.charAt(0)}</div>
            <div class="user-details-card">
              <p class="user-name-card">${user.fullName}</p>
              <p class="user-role-card">${getRoleDisplayName(user.role)} ‚Ä¢ ${user.username}</p>
            </div>
          </div>
          <div style="display: flex; gap: 8px;">
            ${canDeleteUser(user) ? `<button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteUser('${user.id}')">‡∏•‡∏ö</button>` : ''}
          </div>
        </div>
      `).join('');
    }

    function canDeleteUser(user) {
      return currentUser.role === 'admin' && user.id !== currentUser.id;
    }

    function showAddUser() {
      document.getElementById('addUserForm').style.display = 'block';
    }

    function hideAddUser() {
      document.getElementById('addUserForm').style.display = 'none';
      document.getElementById('userForm').reset();
    }

    document.getElementById('userForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (isLoading) return;
      
      if (getAllUsers().length >= 999) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'error');
        return;
      }

      isLoading = true;
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...';
      submitBtn.disabled = true;

      const username = document.getElementById('newUsername').value;
      const allUsers = getAllUsers();
      
      if (allUsers.find(u => u.username === username)) {
        showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
        isLoading = false;
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return;
      }

      const newUser = {
        id: Date.now().toString(),
        type: 'user',
        username: username,
        password: document.getElementById('newPassword').value,
        fullName: document.getElementById('newFullName').value,
        role: document.getElementById('newRole').value,
        department: getDepartmentFromRole(document.getElementById('newRole').value),
        createdAt: new Date().toISOString()
      };

      const createResult = await window.dataSdk.create(newUser);
      
      if (createResult.isOk) {
        showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        hideAddUser();
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');
      }
      
      isLoading = false;
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    });

    async function deleteUser(userId) {
      if (isLoading) return;
      
      const confirmBtn = event.target;
      const originalText = confirmBtn.textContent;
      confirmBtn.textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
      confirmBtn.style.background = '#D32F2F';
      
      setTimeout(() => {
        confirmBtn.textContent = originalText;
        confirmBtn.style.background = '';
      }, 3000);
      
      if (confirmBtn.dataset.confirmed === 'true') {
        isLoading = true;
        const allUsers = getAllUsers();
        const user = allUsers.find(u => u.id === userId);
        
        if (user) {
          const deleteResult = await window.dataSdk.delete(user);
          
          if (deleteResult.isOk) {
            showToast('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          } else {
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');
          }
        }
        
        isLoading = false;
        confirmBtn.dataset.confirmed = 'false';
      } else {
        confirmBtn.dataset.confirmed = 'true';
      }
    }

    // Initialize app on load
    initializeApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99b4888ac7e1d33a',t:'MTc2MjU5OTI3Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
